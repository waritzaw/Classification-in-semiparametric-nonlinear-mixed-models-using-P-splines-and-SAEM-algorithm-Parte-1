install.packages("tidyverse")
X11()
matrix(c(1:2), nrow=1, byrow=FALSE)
layout(matrix(c(1:2), nrow=1, byrow=FALSE))
layout.show(2)
plot.roc(objroc,print.auc=T,print.thres = "best", main = "ROC curve NLME Model",
col="blue",xlab="Especificidad",ylab="Sensibilidad")
plot.roc(objroc2,print.auc=T,print.thres = "best", main = "ROC curve SPNLME (11n) Model",
col="black",xlab="Especificidad",ylab="Sensibilidad")
X11()
matrix(c(1:2), nrow=1, byrow=FALSE)
layout(matrix(c(1:2), nrow=1, byrow=FALSE))
layout.show(2)
plot.roc(objroc,print.auc=TRUE,print.thres = "best", main = "ROC curve NLME Model",
col="blue",xlab="Especificidad",ylab="Sensibilidad")
library(ROCR)
library(pROC)
res.final<-data.frame(prob=c(p.clas.n,p.clas.a),group=c(rep(1,124),rep(0,49)))
pred <- prediction(res.final$prob, res.final$group)
objroc <- roc(res.final$group, res.final$prob, auc=T, ci=T)
library(ROCR)
library(pROC)
res.final<-data.frame(prob=c(p.clas.n,p.clas.a),group=c(rep(1,124),rep(0,49)))
pred <- prediction(res.final$prob, res.final$group)
fit.n<-nlmeEN.fit
fit.a<-nlmeEA.fit
pi.norm<-pi.is(nlmeEN.fit)
llis.saemix()
llis.saemix
llis.saemix
llis.saemix(saemixObject)
llis.saemix(saemixObject)
library(saemix)
llis.saemix(saemixObject)
llis.saemix()
llis.saemix(help)
library(saemix)
llis.saemix
library(saemix)
llis.saemix
print(llis.saemix)
llis.saemix
setwd("~/Desktop/TESIS DOCTORADO/Material Suplementario/Modelos Data Simulada/Rstudio/SPNLME-EN")
setwd("~/Desktop/TESIS DOCTORADO/Material Suplementario/Modelos Data Simulada/Rstudio/SPNLME-EN")
library(saemix)
library(ggplot2)
library(sitar)
par(mar=rep(2,4))
data <- read.table("data/datasimul.csv", header=T)
colnames(data)[1:4]<-c("id","time","y","grupo")
data <- read.csv("data/datasimul.csv", header=T)
data <- read.csv("data/datasimul.csv", header=T)
data$X <- NULL
View(data)
library(saemix)
library(sitar)
library(ggplot2)
require(gridExtra)
library(colourpicker)
par(mar=rep(2,4))
data <- read.csv("data/datasimul.csv", header=T)
data$X <- NULL
dataEN <- dataE[dataE$grupo == 0,]  #normal pregnancies data
dataEN <- dataE[data$grupo == 0,]  #normal pregnancies data
dataEN <- data[data$grupo == 0,]  #normal pregnancies data
View(dataEN)
nlmeEN.data <-saemixData(name.data=dataEN,header=TRUE,sep=" ",na=NA,
name.group=c("id"),name.predictors=c("time"),
name.response=c("y"),
units=list(x="days",y="log(beta-HCG)-EN"),name.X="time")
logEN<-function(psi,id,xidep) {
tim<-xidep[,1]
a<-psi[id,1]
b<-psi[id,2]
c<-psi[id,3]
ypred<-a/(1+exp(-(tim-b)/c))
return(ypred)
}
nlmeEN.model<-saemixModel(model=logEN,description="longitudinal model EN",
psi0=matrix(c(4,15,7,0,0,0),ncol=3,byrow=TRUE, dimnames=list(NULL, c("a","b","c"))),
transform.par=c(0,0,0),omega.init=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,byrow=TRUE),
covariance.model=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,
byrow=TRUE))
##RUNS
K1 = 500
K2 = 100
iterations = 1:(K1+K2+1)
end = K1+K2
options.nlme <-list(seed=139546,map=FALSE,fim=FALSE,ll.is=TRUE,
nbiter.mcmc = c(2,2,2), nbiter.saemix = c(K1,K2),
displayProgress = TRUE,save.graphs = FALSE,nbiter.burn = 0)
nlmeEN.fit <- saemix(nlmeEN.model,nlmeEN.data,options.nlme)
options.nlme <-list(seed=139546,map=FALSE,fim=FALSE,ll.is=TRUE,
nbiter.mcmc = c(2,2,2,0), nbiter.saemix = c(K1,K2),
displayProgress = TRUE,save.graphs = FALSE,nbiter.burn = 0)
nlmeEN.fit <- saemix(nlmeEN.model,nlmeEN.data,options.nlme)
plot(nlmeEN.fit, plot.type="individual.fit")
library(lattice)
xyplot(y + fitted(nlmeEN.fit) ~ time | id, data = dataEN,
subset = c(which(id==14), which(id==36), which(id==62), which(id==65), which(id==41),
which(id==68),which(id==80), which(id==91), which(id==120), which(id==122)),
strip = FALSE, aspect = "xy", pch = 16, grid = TRUE,
type = c("p","l"), distribute.type = TRUE, col.line=c("blue","#DB3B1B"), lwd=2,
xlab = "days", ylab = "log(beta-HCG)", main="NLME", sub="id - abnormal and normal group",
auto.key = list(points=FALSE, lines = FALSE, space = "right", text= c("Observations","NLME"),
col=c("blue","#DB3B1B")))
xyplot(y + fitted(nlmeEN.fit) ~ time | id, data = dataEN,
subset = c(which(id==14), which(id==36), which(id==62), which(id==65), which(id==41),
which(id==68),which(id==80), which(id==91), which(id==120), which(id==122)),
strip = FALSE, aspect = "xy", pch = 16, grid = TRUE,
type = c("p","l"), distribute.type = TRUE, col.line=c("blue","#DB3B1B"), lwd=2,
xlab = "days", ylab = "log(beta-HCG)", main="NLME", sub="id - normal group",
auto.key = list(points=FALSE, lines = FALSE, space = "right", text= c("Observations","NLME"),
col=c("blue","#DB3B1B")))
setwd("~/Desktop/TESIS DOCTORADO/Material Suplementario/Modelos Data Simulada/Rstudio/SPNLME.b2")
library(saemix)
library(sitar)
library(ggplot2)
require(gridExtra)
library(colourpicker)
data <- read.csv("data/datasimul.csv", header=T)
data$X <- NULL
#Longitudinal data structure used by SAEMIX
data.nlme <- saemixData(name.data=data,header=TRUE,sep=" ",na=NA,
name.group=c("id"),name.predictors=c("time"),
name.response=c("y"),
units=list(x="days",y="log(beta-HCG)"),name.X="time")
modellog<-function(psi,id,xidep) {
tim<-xidep[,1]
a<-psi[id,1]
b<-psi[id,2]
c<-psi[id,3]
ypred<-a/(1+exp(-(tim-b)/c))
return(ypred)
}
#Saemix model
nlme.model<-saemixModel(model=modellog,description="Longitudinal model",
psi0=matrix(c(4,15,7,0,0,0),ncol=3,byrow=TRUE, dimnames=list(NULL, c("a","b","c"))),
transform.par=c(0,0,0),omega.init=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,byrow=TRUE),
covariance.model=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,
byrow=TRUE))
##RUNS
K1 = 500
K2 = 100
iterations = 1:(K1+K2+1)
end = K1+K2
options.nlme<-list(seed=139546,map=FALSE,fim=FALSE,ll.is=TRUE,
nbiter.mcmc = c(2,2,2,0), nbiter.saemix = c(K1,K2),
displayProgress = TRUE,save.graphs = FALSE,nbiter.burn = 0)
nlme.fit <- saemix(nlme.model,data.nlme,options_bHCG)
nlme.fit <- saemix(nlme.model,data.nlme,options.nlme)
plot(nlme.fit, plot.type="individual.fit")
library(lattice)
xyplot(y + fitted(nlme.fit) ~ time | id, data = data,
subset = c(which(id==14), which(id==62), which(id==65), which(id==120),
which(id==130), which(id==136), which(id==158), which(id==169)),
strip = FALSE, aspect = "xy", pch = 16, grid = TRUE,
type = c("p","l"), distribute.type = TRUE, col.line=c("blue","#DB3B1B"), lwd=2,
xlab = "days", ylab = "log(beta-HCG)", main="NLME", sub="id - abnormal and normal group",
auto.key = list(points=FALSE, lines = FALSE, space = "right", text= c("Observations","NLME"),
col=c("blue","#DB3B1B")))
library(splines)
# B-spline
bspline <- function(x,xl,xr,ndx,bdeg){
dx <- (xr-xl)/ndx
knots <- seq(xl-bdeg*dx,xr+bdeg*dx,by=dx)
B <- spline.des(knots,x,bdeg+1,0*x,outer.ok=TRUE)$design
output <- list(knots=knots,B=B)
return(output)
}
# B-spline
bspline <- function(x,xl,xr,ndx,bdeg){
dx <- (xr-xl)/ndx
knots <- seq(xl-bdeg*dx,xr+bdeg*dx,by=dx)
B <- spline.des(knots,x,bdeg+1,0*x,outer.ok=TRUE)$design
output <- list(knots=knots,B=B)
return(output)
}
setwd("~/Desktop/TESIS DOCTORADO/Material Suplementario/Modelos Data Simulada/Rstudio/SPNLME-EN.b2")
library(saemix)
library(sitar)
library(ggplot2)
require(gridExtra)
library(colourpicker)
data <- read.csv("data/datasimul.csv", header=T)
data$X <- NULL
dataEN <- data[data$grupo == 0,]  #data normal pregnancy
nlmeEN.data <-saemixData(name.data=dataEN,header=TRUE,sep=" ",na=NA,
name.group=c("id"),name.predictors=c("time"),
name.response=c("y"),
units=list(x="days",y="log(beta-HCG)-EN"),name.X="time")
logEN<-function(psi,id,xidep) {
tim<-xidep[,1]
a<-psi[id,1]
b<-psi[id,2]
c<-psi[id,3]
ypred<-a/(1+exp(-(tim-b)/c))
return(ypred)
}
nlmeEN.model<-saemixModel(model=logEN,description="Lngitudinal model EN",
psi0=matrix(c(4,15,7,0,0,0),ncol=3,byrow=TRUE, dimnames=list(NULL, c("a","b","c"))),
transform.par=c(0,0,0),omega.init=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,byrow=TRUE),
covariance.model=matrix(c(1,0,0,0,1,0,0,0,1),ncol=3,
byrow=TRUE))
##RUNS
K1 = 500
K2 = 100
c1 = 5
c2 = 5
c3 = 5
iterations = 1:(K1+K2+1)
end = K1+K2
options.nlme <-list(seed=139546,map=FALSE,fim=FALSE,ll.is=TRUE,
nbiter.mcmc = c(c1,c2,c3), nbiter.saemix = c(K1,K2),
displayProgress = TRUE, save.graphs = FALSE, nbiter.burn = 0)
nlmeEN.fit <- saemix(nlmeEN.model, nlmeEN.data, options.nlme)
options.nlme <-list(seed=139546,map=FALSE,fim=FALSE,ll.is=TRUE,
nbiter.mcmc = c(c1,c2,c3,0), nbiter.saemix = c(K1,K2),
displayProgress = TRUE, save.graphs = FALSE, nbiter.burn = 0)
nlmeEN.fit <- saemix(nlmeEN.model, nlmeEN.data, options.nlme)
plot(nlmeEN.fit, plot.type = "individual.fit")
library(splines)
# Obtain the B-spline Basis
bbase <- function(x, xl = min(x), xr = max(x), ndx = ndx, bdeg = bdeg) {
dx <- (xr - xl) / ndx
knots <- seq(xl - bdeg * dx, xr + bdeg * dx, by = dx)
B <- spline.des(knots, x, ord = bdeg + 1, outer.ok = TRUE)$design
res <- list(B = B, knots = knots, bdeg = bdeg)
class(res) <- "bbase"
res
}
# We represent the mixed model for the B-splines
predict.bbase <- function(object, newx, deriv = 0) {
B <- spline.des(knots = object$knots, x = newx, derivs = deriv, ord = object$bdeg + 1, outer.ok = TRUE)$design
B
}
MMSP.basis <- function (x, xl, xr, ndx, bdeg, pord, param = param) {
Bb <- bbase(x,xl,xr,ndx,bdeg)
knots <- Bb$knots
B <- Bb$B
m <- ncol(B)
n <- nrow(B)
D <- diff(diag(m), differences=pord)
P.svd <- svd(crossprod(D))
U.Z <- (P.svd$u)[,1:(m-pord)]
d <- (P.svd$d)[1:(m-pord)]
Z <- B%*%U.Z
U.X <- NULL
if(param == 1) {
U.X = ((P.svd$u)[,-(1:(m-pord))])
X = B%*%U.X
} else if (param == 2){
X <- NULL
for(i in 0:(pord-1)){
X <- cbind(X,x^i)
}
U.X <- NULL
for(i in 0:(pord-1)){
U.X <- cbind(U.X, knots[-c((1:(bdeg - 1)),(length(knots)- (bdeg - 1) + 1):length(knots))]^i)
}
# Note that B%*%U.X == X
} else if(param == 3) {
U.X <- NULL
for(i in 0:(pord-1)){
U.X <- cbind(U.X, knots[-c((1:(bdeg - 1)),(length(knots)- (bdeg - 1) + 1):length(knots))]^i)
}
X <- B%*%U.X
} else if(param == 4) {
X <- B%*%((P.svd$u)[,-(1:(m-pord))])
D.temp <- sweep(X, 2, colMeans(X))
Xf <- svd(crossprod(D.temp))$u[,ncol(D.temp):1]
X <- X%*%Xf
U.X <- ((P.svd$u)[,-(1:(m-pord)), drop = FALSE])%*%Xf
} else if(param == 5) {
U.Z <- (t(D)%*%solve(D%*%t(D)))
Z <- B%*%U.Z
X <- B%*%((P.svd$u)[,-(1:(m-pord))])
D.temp <- sweep(X, 2, colMeans(X))
Xf <- svd(crossprod(D.temp))$u[,ncol(D.temp):1]
X <- X%*%Xf
U.X <- ((P.svd$u)[,-(1:(m-pord)), drop = FALSE])%*%Xf
} else if(param == 6) {
U.Z <- t(D)
Z <- B%*%U.Z
X = B%*%((P.svd$u)[,-(1:(m-pord))])
D.temp <- sweep(X, 2, colMeans(X))
Xf <- svd(crossprod(D.temp))$u[,ncol(D.temp):1]
X <- X%*%Xf
U.X <- ((P.svd$u)[,-(1:(m-pord)), drop = FALSE])%*%Xf
} else if(param == 7) {
U.Z <- contr.sum(ncol(B))%*%contr.sum(ncol(B)-1)
Z <- B%*%U.Z
X <- NULL
for(i in 0:(pord-1)){
X <- cbind(X,x^i)
}
}
list(Bb = Bb, X = X, Z = Z, d = d, m = m, D = D, U.X = U.X, U.Z = U.Z)
}
bdeg  = 3
pord = 2
param = 3
x <- dataEN$time
model.5n <-function(psi, id, x){
RES <- x
tim<-RES[,1]
a<-psi[id,1]
b<-psi[id,2]
c<-psi[id,3]
ypred<-a/(1+exp(-(tim-b)/c))
return(ypred)
##
b1<- psi[id, 4]
b2<- psi[id, 5]
b3<- psi[id, 6]
b4<- psi[id, 7]
b5<- psi[id, 8]
b6<- psi[id, 9]
yspline <- RES[,2]*b1 + RES[,3]*b2 + RES[,4]*b3 + RES[,5]*b4 + RES[,6]*b5 + RES[,7]*b6
resp <- ypred + yspline
return(resp)
}
MSP5 <- MMSP.basis(x, min(x), max(x), ndx = 5, bdeg = bdeg, pord = pord, param = param)
names(MSP5)
X <- MSP5$X
Z <- MSP5$Z
aX <- dim(X)[2]
aZ <- dim(Z)[2]
aD <- dim(dataEN)[2]
RES <- cbind(X,Z)
dataEN5.full <-cbind(dataEN,Z)
colnames(dataEN5.full)[(aD+1):(aD+aZ)] <- paste0("Z",1:ncol(Z))
dataEN5.full.data <- saemixData(name.data = dataEN5.full, header = TRUE,
sep = " ", na = NA,
name.predictors = c("time",paste0("Z",1:aZ)),
name.response = c("y"),
units = list(x = "days", y = "log(beta-HCG)",
covariates = c("-")),
name.X = c("time"))
# Data modelo SPNLME EN 5 knots
write.csv(dataEN5.full, file = "dataEN-SPNLME5.csv", row.names = FALSE)
plot(dataEN5.full.data, plot.type="data")
SPEN5.saemix <-saemixModel(model=model.5n,
description = "Semiparametric Model nodos = 5",
psi0 = matrix(c(coef(nlmeEN.fit)$fixed,rep(0,6)), ncol = 3+aZ, byrow = TRUE,
dimnames = list(NULL, c("a","b","c","b1","b2","b3","b4","b5","b6"))),
transform.par = c(rep(0,3),rep(0,aZ)),
fixed.estim=c(rep(1,3+aZ)),
covariance.model = cbind(rbind(diag(9))))
##RUNS
K3 = 500
K4 = 100
c4 = 5
c5 = 5
c6 = 5
iterations = 1:(K3+K4+1)
end = K3+K4
options.sp<-list(seed=139546,map=FALSE,fim=FALSE,ll.is=TRUE,nb.chains = 5,
nbiter.mcmc = c(c4,c5,c6,0), nbiter.saemix = c(K3,K4),nbiter.sa=0.9,
displayProgress=TRUE,save.graphs=FALSE,nbiter.burn =0)
SPEN5.fit <- saemix(SPEN5.saemix, dataEN5.full.data, options_SP)
SPEN5.fit <- saemix(SPEN5.saemix, dataEN5.full.data, options.sp)
plot(SPEN5.fit, plot.type="individual.fit")
library(lattice)
xyplot(y + fitted(nlmeEN.fit) + fitted(SPEN5.fit) ~ time | id, data = dataEN5.full,
subset = c(which(id==14), which(id==30), which(id==41), which(id==68),
which(id==80),which(id==91), which(id==120), which(id==122)),
strip = TRUE, pch = 16, grid = TRUE,
type = c("p","l","l"), distribute.type = TRUE, col.line=c("blue","black","magenta"),
xlab = "days", ylab = "log(beta-HCG)",layout=c(4,2),
auto.key =list(points = FALSE,lines = FALSE, space = "right",
text = c("Observaciones","NLME","SMNLME 5n"),
col=c("blue","black","magenta")))
xyplot(y + fitted(nlmeEN.fit) + fitted(SPEN5.fit) ~ time | id, data = dataEN5.full,
subset = c(which(id==14), which(id==30), which(id==41), which(id==68),
which(id==80),which(id==91), which(id==120), which(id==122)),
strip = FALSE, aspect = "xy", pch = 16, grid = TRUE,
type = c("p","l","l"), distribute.type = TRUE, col.line=c("blue","black","magenta"),
xlab = "days", ylab = "log(beta-HCG)",layout=c(4,2),
auto.key =list(points = FALSE,lines = FALSE, space = "right",
text = c("Observaciones","NLME","SPNLME 5n"),
col=c("blue","black","magenta")))
xyplot(y + fitted(nlmeEN.fit) + fitted(SPEN5.fit) ~ time | id, data = dataEN5.full,
subset = c(which(id==14), which(id==30), which(id==41), which(id==68),
which(id==80),which(id==91), which(id==120), which(id==122)),
strip = FALSE, aspect = "xy", pch = 16, grid = TRUE,
type = c("p","l","l"), distribute.type = TRUE,col.line=c("blue","#DB3B1B","#E6CE17"), lwd=2,
xlab = "days", ylab = "log(beta-HCG)",layout=c(4,2),
auto.key =list(points = FALSE,lines = FALSE, space = "right",
text = c("Observaciones","NLME","SPNLME 5n"),
col=c("blue","black","magenta")))
xyplot(y + fitted(nlmeEN.fit) + fitted(SPEN5.fit) ~ time | id, data = dataEN5.full,
subset = c(which(id==14), which(id==30), which(id==41), which(id==68),
which(id==80),which(id==91), which(id==120), which(id==122)),
strip = FALSE, aspect = "xy", pch = 16, grid = TRUE,
type = c("p","l","l"), distribute.type = TRUE,col.line=c("blue","#DB3B1B","#E6CE17"), lwd=2,
xlab = "days", ylab = "log(beta-HCG)", main="NLME - SPNLME 5k", sub="id - normal group",
auto.key = list(points=FALSE, lines = FALSE, space = "right", text= c("Observations","NLME", "Bspline 5 knots"),
col=c("blue","#DB3B1B","#E6CE17")))
library(saemix)
library(sitar)
library(ggplot2)
require(gridExtra)
par(mar=rep(2,4))
library(colourpicker)
library(lattice)
xyplot(y + fitted(nlmeEN.fit) + fitted(SPEN5.fit) ~ time | id, data = dataEN5.full,
subset = c(which(id==14), which(id==30), which(id==41), which(id==68),
which(id==80),which(id==91), which(id==120), which(id==122)),
strip = FALSE, aspect = "xy", pch = 16, grid = TRUE,
type = c("p","l","l"), distribute.type = TRUE,col.line=c("blue","#DB3B1B","#E6CE17"), lwd=2,
xlab = "days", ylab = "log(beta-HCG)", main="NLME - SPNLME 5k", sub="id - normal group",
auto.key = list(points=FALSE, lines = FALSE, space = "right", text= c("Observations","NLME", "Bspline 5 knots"),
col=c("blue","#DB3B1B","#E6CE17")))
